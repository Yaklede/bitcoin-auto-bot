# 비트코인 매매봇 실행계획 (Equity 우상향 중심) <!-- plan.md -->

> **목표:** 승률이 낮아도 *기대수익(Expectancy)* 이 플러스가 되도록 리스크 관리·포지션 사이징·손익비 구조를 설계하여 잔고의 **우상향**을 달성한다. (예: 승률 35\~45%라도 평균이익이 평균손실의 ≥1.8배)

---

## 1) 원칙 & 성공 기준

* **우선순위:** 리스크 관리 > 일관성 > 거래 아이디어 > 최적화
* **손익비 구조:** 손실은 짧게(잘라내기), 이익은 길게(트레일링)
* **한 트레이드 위험(R):** 계좌의 0.25%\~1.0% (초기 0.5% 권장)
* **일일 손실 한도(Daily Stop):** -2R (초기 중지)
* **주간 손실 한도(Weekly Circuit Breaker):** -5R (전략 재검토)
* **검증 지표(백테스트·실거래 공통):**

    * Profit Factor ≥ 1.2, CAGR > 무위험수익률 + 8%p
    * MDD ≤ 20\~30% (선호 범위), Ulcer Index ↓
    * 승률과 무관하게 **E = p·avgWin − (1−p)·avgLoss > 0**
* **편향 방지:** 룩어헤드/서바이벌/파라미터 과최적화 방지 (WF/WFA)

---

## 2) 시스템 아키텍처 개요

* **거래소:** (권장) 업비트 Spot(KRW-BTC) → 이후 필요 시 파생으로 확장
* **구성:**

    * Ingestion: 시세/호가/체결 데이터 수집 (REST + WebSocket)
    * Strategy: 시그널 엔진(예: RSI Mean Reversion, 추세추종, 변동성 돌파)
    * Risk: 포지션 사이징, 손익비/스탑/트레일러, 일·주 손실 컷
    * Broker: 주문 라우팅, 슬리피지·수수료 반영, 정밀도/최소수량 체크
    * State: 포지션/주문/체결/현금·잔고 스냅샷
    * Storage: 시세DB(OHLCV), 체결/주문 로그, 지표 캐시
    * Monitor: 대시보드, 슬랙/텔레그램 알림, 헬스체크/킬스위치
* **언어/프레임워크 예시:**

    * Python(+ccxt) 또는 Kotlin/Spring(+업비트 API), n8n(자동화) 보조
* **안전장치:** API 키 읽기/거래만 허용(출금 비활성), 재시도/멱등키, 중복주문 방지

---

## 3) 단계별 실행 계획 & 체크리스트

### A. 요구사항 정의 (Day 0\~1)

* [ ] 대상시장: **KRW-BTC**(Spot) 확정
* [ ] 목표 메트릭/제약 정의: 손익비, 1일/1주 손실 한도, MDD 목표
* [ ] 거래 세션 정책: 24/7, 점검 창구(정기 유지보수 시간) 정의
* [ ] 초기 자본·슬리피지 가정·수수료(테이커 기준) 확정
* [ ] 법규/세무 리스크 검토(개인 판단, 필요 시 전문가 자문)

### B. 데이터 레이어 (Day 1\~3)

* [ ] **OHLCV 해상도:** 1m 수집 → 5m/15m/1h 집계
* [ ] **시간 동기화:** UTC 저장, KST 변환 표시 (서머타임 무영향)
* [ ] **정합성:** 결측 캔들 보간 규칙, 스파이크/이상치 필터
* [ ] **수수료/슬리피지 모델:** 백테스트에 **반드시** 반영
* [ ] 속도 제한/쿼터 준수, 재시도·지수백오프 구현

### C. 전략 리서치 (Day 3\~10)

주 전략은 “승률 낮아도 우상향” 구조에 유리한 조합:

* **추세추종(35\~45% 승률, 손익비 큼):**

    * 예) 20/50 EMA 크로스 + **ATR 기반 트레일링 스탑**
* **변동성 돌파:**

    * 예) 전일 Range의 k배 돌파 + ATR 트레일러
* **역추세(RSI) — 보조 전략(낮은 레버, 넓은 스탑):**

    * 예) RSI(14) < 25 분할매수, RSI(50\~55) 청산 또는 트레일링 전환
* [ ] 각 전략별 **명시적 규칙**과 **시장 상태 필터**(상승/하락/변동성 구간) 정의
* [ ] **겹침/동시 시그널 충돌 규칙**(우선순위·합성 로직) 확정
* [ ] 빈도/보유기간/슬리피지 민감도 분석

### D. 리스크 & 포지션 사이징 (Day 7\~10)

* **고정비율 리스크:**
  `size = (risk_per_trade * equity) / stop_distance`
  예) R=0.5%, ATR 2배를 stop\_distance로 사용
* [ ] **일일 손실 -2R 중지**, 주간 -5R 중지
* [ ] **최대 동시노출:** 단일자산이므로 **단일 포지션 유지** 원칙 권장
* [ ] **주문 정밀도/최소수량/틱사이즈** 체크(거래소 제약 반영)
* [ ] **테일리스크 대응:** 급락시 시장가 청산 + 재진입 쿨다운

### E. 백테스트 (Day 10\~16)

* [ ] 수수료/슬리피지/미체결·부분체결 시뮬, 호가단위 반영
* [ ] **워크포워드 최적화(WFO)**: 2019~~2023 훈련 → 2024~~2025 검증 (예시)
* [ ] **부트스트랩/몬테카를로**로 순서 민감도·리스크오브루인 추정
* [ ] 핵심 출력: CAGR, MDD, PF, Sharpe/Sortino, 승률, 평균R, **E>0 확인**
* [ ] **과최적화 테스트:** 파라미터 ±20% 러프니스 견디는지 확인

### F. 페이퍼 트레이딩 (Day 16\~20)

* [ ] 실시간 데이터/지표 일치성(백테스트 vs 실시간) 검증
* [ ] 주문 경로·실행지연·체결률·슬리피지 실측
* [ ] 손실·이상치·API 오류 **알림** 검증 (슬랙/텔레그램/이메일)
* [ ] **킬스위치**(수동/자동), 재시작 시 상태복구(idempotency) 점검

### G. 소액 실거래(베타) (Day 20\~30)

* [ ] 초기 리스크 50% 축소(예: R=0.25%)
* [ ] 2주간 지표/로그/알림 **무사고** → R 원복 여부 결정
* [ ] **드로다운 규칙** 준수 확인, 수동 개입 최소화

### H. 운영 & 개선 (지속)

* [ ] 주간 리포트: 손익, R-multiple 분포, 규칙 위반, 알림 통계
* [ ] 월간: 파라미터 드리프트 점검(재최적화는 분기 단위 이하)
* [ ] 버전 고정 및 변경관리(전략/리스크 레일 변경 시 릴리즈 노트 필수)

---

## 4) 전략 템플릿 (예시 규칙)

### 4.1 추세추종 (권장 메인)

* 진입: 20EMA > 50EMA **그리고** Pullback(5\~10%) 후 전고 돌파
* 초기 스탑: **ATR(14) × 2.5**
* 트레일링: **Chandelier(ATR 3)** 또는 **SuperTrend**
* 청산: 트레일 스탑 히트 또는 추세 반전(20<50)
* 기대: 승률 낮아도 **손익비 2\~3+** 확보

### 4.2 변동성 돌파

* 진입: 시가 + k × (전일 고-저) 돌파 (k=0.5\~0.7)
* 필터: 50EMA 상승 구간만 매수
* 스탑/트레일: ATR 기반

### 4.3 RSI 역추세(보조)

* 진입: RSI(14) < 25에서 **2\~3회 분할**
* 청산: RSI 50\~55 또는 트레일 전환
* 주의: 추세장에서는 손실 길어지므로 **노이즈 구간 필터** 필요 (예: ADX<20)

---

## 5) 리스크·자금관리 상세

* **R 고정:** 계좌 0.5% 손실이 최대 1R이 되도록 수량 계산
* **분할 진입/청산:** 평균가격/심리 안정, 단 **R 초과 금지**
* **일일·주간 컷:** 손실 확대 방지, 감정 개입 차단
* **변동성 타게팅:** ATR↑ 시 수량↓, ATR↓ 시 수량↑ (위험 균등화)
* **거래 중단 규칙:** 급격한 체결지연·API 에러 급증·슬리피지 이상 시 즉시 Flat

---

## 6) 백테스트/검증 체크리스트

* [ ] 룩어헤드 금지(캔들 종가 확정 후 다음 바 실행)
* [ ] 생존편향 제거(상장폐지/빅 이벤트 포함 시나리오)
* [ ] 수수료(테이커) + 슬리피지(보수적으로) 반영
* [ ] 주문 제약: 최소주문수량, 가격·수량 소수점, 틱사이즈
* [ ] 부분체결·거부·재시도 로직 시뮬
* [ ] 파라미터 민감도/러그드니스, WFO, MC 리샘플링
* [ ] 리스크오브루인 < 1\~2% 목표

---

## 7) 운영·모니터링

* **대시보드:** 누적 PnL, MDD, 현재 R, 노출, 미실현손익, 최근 체결
* **알림:** 신규 진입/증액/청산, 스탑 체결, 일일 손실 컷, 오류/지연
* **헬스체크:** 데이터 지연, 주문 실패율, WS 재연결 횟수
* **로그 레벨:** 주문/체결(INFO), 시그널(DEBUG), 오류(ERROR)
* **릴리즈 절차:** Staging → 페이퍼 48h → 소액 실거래

---

## 8) 보안·안전·준법

* [ ] API 키: **거래 전용, 출금 비활성, IP 제한**
* [ ] 시크릿/환경변수 분리, KMS/Secrets Manager
* [ ] 재시작 안전(포지션·주문 상태 복원)
* [ ] 타임아웃/재시도/멱등키로 **중복주문 방지**
* [ ] 로그에 민감정보 마스킹
* [ ] 현지 법규·세무는 별도 검토

---

## 9) 예시 설정 (YAML)

```yaml
exchange:
  name: upbit
  market: KRW-BTC
  taker_fee_bps: 25   # 0.25% 예시
  slippage_bps: 10    # 보수적 가정

risk:
  r_per_trade_bps: 50  # 0.5% = 50bps
  daily_stop_R: -2
  weekly_stop_R: -5
  max_position: 1      # 단일 포지션

strategy:
  main: trend_follow
  params:
    ema_fast: 20
    ema_slow: 50
    atr_len: 14
    init_stop_atr: 2.5
    trail_type: chandelier
    trail_atr_mult: 3.0
filters:
  only_long_when_fast_gt_slow: true
```

---

## 10) 포지션 사이징 의사코드

```python
equity = get_account_equity()
atr = get_ATR(14)
entry = current_price()
stop = entry - 2.5 * atr
risk_per_trade = 0.005 * equity           # 0.5% R
stop_distance = entry - stop
qty = floor_to_tick(risk_per_trade / stop_distance)

place_order(qty, entry, stop, trail=3*atr)
```

---

## 11) n8n/알림 파이프라인(선택)

* 트리거(시그널 발생) → 주문 API → 체결 웹훅 → 슬랙/텔레그램 메시지
* 일일 리포트(손익, R, MDD, 규칙 위반) 자동 전송

---

## 12) 롤아웃 일정(예시)

* 주 1: 데이터/엔진 뼈대 + 기본 전략 1개
* 주 2: 백테스트 + WFO + 페이퍼
* 주 3: 소액 실거래 시작, 모니터링 안정화
* 주 4: 파라미터 러그드니스/리스크 튜닝, 문서화/자동리포팅

---

## 13) 마지막 점검 질문(체크박스)

* [ ] **E>0** 인가? (승률 낮아도 손익비로 커버되는가)
* [ ] **R 규율**이 코드로 강제되는가 (수동 개입 여지 최소화)
* [ ] **일·주 손실 컷**이 실제로 동작하며 로그/알림이 남는가
* [ ] **재시작 안전**(중단 후 재가동 시 포지션/주문 일치)
* [ ] **데이터 지연/누락/이상치**에 대한 방어 코드가 있는가
* [ ] **슬리피지·수수료**를 보수적으로 가정했는가
* [ ] **릴리즈 절차**(페이퍼→소액→확대) 준수 계획인가

---

### 부록) 기대수익 예시

* 승률 p=0.40, 평균이익 = **+2.4R**, 평균손실 = **−1.0R**
  → **E = 0.40×2.4 − 0.60×1.0 = +0.36R**
  → 100 트레이드 시 기대 +36R (우상향 구조)

---

필요하면 **업비트 기준 주문/정밀도/최소수량 체크 로직**, 또는 **RSI/추세 혼합 전략 코드**를 바로 붙여서 드릴게요.
